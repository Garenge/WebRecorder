<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>视频对比功能测试</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        button { padding: 10px 20px; margin: 5px; }
    </style>
</head>
<body>
    <h1>🧪 视频对比功能测试</h1>
    
    <div class="test-section">
        <h3>1. 脚本加载测试</h3>
        <button onclick="testScriptLoading()">测试脚本加载</button>
        <div id="scriptTestResult"></div>
    </div>
    
    <div class="test-section">
        <h3>2. VideoComparisonHelper 测试</h3>
        <button onclick="testHelperClass()">测试助手类</button>
        <div id="helperTestResult"></div>
    </div>
    
    <div class="test-section">
        <h3>3. 初始化测试</h3>
        <button onclick="testInitialization()">测试初始化</button>
        <div id="initTestResult"></div>
    </div>
    
    <div class="test-section">
        <h3>4. 完整功能测试</h3>
        <button onclick="testFullFunction()">测试完整功能</button>
        <div id="fullTestResult"></div>
    </div>

    <!-- FFmpeg.wasm 库 -->
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.12.10/dist/umd/ffmpeg.js"></script>
    <script src="https://unpkg.com/@ffmpeg/util@0.12.1/dist/umd/util.js"></script>
    
    <!-- 应用脚本 -->
    <script src="video-comparison-helper.js"></script>
    
    <script>
        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const className = type === 'success' ? 'success' : type === 'error' ? 'error' : 'info';
            element.innerHTML += `<div class="${className}">${message}</div>`;
        }
        
        function clearLog(elementId) {
            document.getElementById(elementId).innerHTML = '';
        }
        
        async function testScriptLoading() {
            clearLog('scriptTestResult');
            log('scriptTestResult', '🔍 检查脚本加载状态...');
            
            // 检查所有可能的FFmpeg全局变量
            const ffmpegVars = ['FFmpeg', 'ffmpeg', 'FFmpegWASM', 'ffmpegWASM'];
            let ffmpegFound = false;
            
            for (const varName of ffmpegVars) {
                if (typeof window[varName] !== 'undefined') {
                    log('scriptTestResult', `✅ ${varName} 库已加载`, 'success');
                    ffmpegFound = true;
                    break;
                }
            }
            
            if (!ffmpegFound) {
                log('scriptTestResult', '❌ FFmpeg 库未加载', 'error');
                log('scriptTestResult', '🔍 检查window对象中的FFmpeg相关变量...', 'info');
                for (const key in window) {
                    if (key.toLowerCase().includes('ffmpeg')) {
                        log('scriptTestResult', `📋 发现: window.${key} = ${typeof window[key]}`, 'info');
                    }
                }
            }
            
            // 检查FFmpegUtil
            const utilVars = ['FFmpegUtil', 'ffmpegUtil', 'FFmpegUtils', 'ffmpegUtils'];
            let utilFound = false;
            
            for (const varName of utilVars) {
                if (typeof window[varName] !== 'undefined') {
                    log('scriptTestResult', `✅ ${varName} 库已加载`, 'success');
                    utilFound = true;
                    break;
                }
            }
            
            if (!utilFound) {
                log('scriptTestResult', '❌ FFmpegUtil 库未加载', 'error');
            }
            
            // 检查VideoComparisonHelper
            if (typeof window.VideoComparisonHelper !== 'undefined') {
                log('scriptTestResult', '✅ VideoComparisonHelper 类已加载', 'success');
            } else {
                log('scriptTestResult', '❌ VideoComparisonHelper 类未加载', 'error');
            }
        }
        
        async function testHelperClass() {
            clearLog('helperTestResult');
            log('helperTestResult', '🔍 测试 VideoComparisonHelper 类...');
            
            try {
                if (typeof window.VideoComparisonHelper === 'undefined') {
                    throw new Error('VideoComparisonHelper 类未定义');
                }
                
                const helper = new window.VideoComparisonHelper();
                log('helperTestResult', '✅ 成功创建 VideoComparisonHelper 实例', 'success');
                
                log('helperTestResult', `📊 实例状态: isInitialized=${helper.isInitialized}`, 'info');
                
            } catch (error) {
                log('helperTestResult', `❌ 创建实例失败: ${error.message}`, 'error');
            }
        }
        
        async function testInitialization() {
            clearLog('initTestResult');
            log('initTestResult', '🔍 测试初始化过程...');
            
            try {
                if (typeof window.VideoComparisonHelper === 'undefined') {
                    throw new Error('VideoComparisonHelper 类未定义');
                }
                
                const helper = new window.VideoComparisonHelper();
                log('initTestResult', '✅ 创建助手实例成功', 'success');
                
                log('initTestResult', '🔄 开始初始化...', 'info');
                await helper.initialize();
                
                log('initTestResult', '✅ 初始化成功', 'success');
                log('initTestResult', `📊 初始化状态: ${helper.isInitialized}`, 'info');
                
            } catch (error) {
                log('initTestResult', `❌ 初始化失败: ${error.message}`, 'error');
                console.error('初始化错误详情:', error);
            }
        }
        
        async function testFullFunction() {
            clearLog('fullTestResult');
            log('fullTestResult', '🔍 测试完整功能...');
            
            try {
                // 等待FFmpeg加载
                log('fullTestResult', '⏳ 等待FFmpeg库加载...', 'info');
                let attempts = 0;
                while (attempts < 50) {
                    if (typeof window.FFmpeg !== 'undefined' && typeof window.FFmpegUtil !== 'undefined') {
                        break;
                    }
                    await new Promise(resolve => setTimeout(resolve, 100));
                    attempts++;
                }
                
                if (attempts >= 50) {
                    throw new Error('FFmpeg库加载超时');
                }
                
                log('fullTestResult', '✅ FFmpeg库加载完成', 'success');
                
                // 创建助手实例
                const helper = new window.VideoComparisonHelper();
                await helper.initialize();
                
                log('fullTestResult', '✅ 视频对比功能初始化成功', 'success');
                log('fullTestResult', '🎉 所有测试通过！', 'success');
                
            } catch (error) {
                log('fullTestResult', `❌ 完整功能测试失败: ${error.message}`, 'error');
                console.error('完整功能测试错误详情:', error);
            }
        }
        
        // 页面加载完成后自动运行脚本加载测试
        window.addEventListener('load', () => {
            setTimeout(testScriptLoading, 1000);
        });
    </script>
</body>
</html>