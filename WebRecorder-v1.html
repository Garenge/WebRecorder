<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>å±å¹•å½•åˆ¶ Demo</title>
  <style>
    body { font-family: sans-serif; text-align: center; padding: 40px; }
    button { margin: 10px; padding: 10px 20px; font-size: 16px; }
    video { margin-top: 20px; max-width: 100%; border: 1px solid #ccc; }
    
    /* å®æ—¶æ›´æ–°åŠ¨ç”»æ•ˆæœ */
    @keyframes pulse {
      0% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.2); opacity: 0.7; }
      100% { transform: scale(1); opacity: 1; }
    }
    
    @keyframes flash {
      0% { background-color: transparent; }
      50% { background-color: #ffeb3b; }
      100% { background-color: transparent; }
    }
    
    .cache-updating {
      animation: flash 0.3s ease-in-out;
    }
    
    /* ç¦ç”¨çŠ¶æ€çš„æ ·å¼ */
    select:disabled {
      background-color: #f5f5f5;
      color: #999;
      cursor: not-allowed;
    }
    
    select:disabled option {
      color: #999;
    }
  </style>
</head>
<body>
  <h2>Edge å±å¹•å½•åˆ¶ Demo</h2>
  <div style="margin: 10px 0; padding: 10px; background-color: #f9f9f9; border-radius: 5px;">
    <label for="memoryThreshold">å†…å­˜é˜ˆå€¼è®¾ç½®:</label>
    <select id="memoryThreshold" style="padding: 5px; margin: 5px;">
      <option value="1" selected>1 MB</option>
      <option value="5">5 MB</option>
      <option value="10">10 MB</option>
      <option value="20">20 MB</option>
      <option value="50">50 MB</option>
    </select>
    <span style="color: #666; font-size: 12px;">è¾¾åˆ°é˜ˆå€¼æ—¶è‡ªåŠ¨ä¿å­˜æ–‡ä»¶</span>
    <br>
    <span id="currentThreshold" style="color: #007bff; font-size: 12px; font-weight: bold;">å½“å‰é˜ˆå€¼: 1 MB</span>
    <br><br>
    <label for="recordingMode">å½•åˆ¶æ¨¡å¼:</label>
    <select id="recordingMode" style="padding: 5px; margin: 5px;">
      <option value="single" selected>å•æ–‡ä»¶æ¨¡å¼ (æ¨è)</option>
      <option value="multiple">å¤šæ–‡ä»¶æ¨¡å¼</option>
    </select>
    <span style="color: #666; font-size: 12px;">å•æ–‡ä»¶æ¨¡å¼ä¼šç´¯ç§¯æ‰€æœ‰æ•°æ®ï¼Œå½•åˆ¶ç»“æŸæ—¶ç”Ÿæˆä¸€ä¸ªå®Œæ•´æ–‡ä»¶</span>
  </div>
  
  <!-- çŠ¶æ€ä¿¡æ¯åŒºåŸŸ -->
  <div style="margin: 10px 0; padding: 10px; background-color: #e8f4fd; border-radius: 5px; border-left: 4px solid #007bff;">
    <strong>å½“å‰çŠ¶æ€:</strong> <span id="recordingStatus">æœªå½•åˆ¶</span>
    <br>
    <div style="display: flex; align-items: center; margin: 2px 0;">
      <strong style="width: 100px; text-align: left;">å½“å‰ç¼“å­˜:</strong>
      <span id="cacheSize" style="min-width: 80px; text-align: right; font-family: monospace; font-weight: bold;">0.00 MB</span>
      <span id="changeIndicator" style="color: #4CAF50; font-weight: bold; margin-left: 5px;"></span>
    </div>
    <div style="display: flex; align-items: center; margin: 2px 0;">
      <strong style="width: 100px; text-align: left;">å·²ä¿å­˜æ–‡ä»¶:</strong>
      <span id="savedFiles" style="min-width: 80px; text-align: right; font-family: monospace; font-weight: bold;">0 ä¸ª</span>
    </div>
    <div style="display: flex; align-items: center; margin: 2px 0;">
      <strong style="width: 100px; text-align: left;">ç´¯è®¡å½•åˆ¶:</strong>
      <span id="totalRecorded" style="min-width: 80px; text-align: right; font-family: monospace; font-weight: bold;">0.00 MB</span>
    </div>
    <br>
    <div id="filePathInfo" style="margin-top: 10px; padding: 8px; background-color: #f8f9fa; border-radius: 3px; font-size: 12px; display: none;">
      <strong>æ–‡ä»¶è·¯å¾„:</strong> <span id="currentFilePath">-</span>
    </div>
  </div>
  
  <button id="startBtn">å¼€å§‹å½•åˆ¶</button>
  <button id="stopBtn" disabled>åœæ­¢å½•åˆ¶</button>
  <button id="clearMemoryBtn" style="background-color: #ff6b6b; color: white;">æ¸…ç†å†…å­˜</button>
  <button id="mergeFilesBtn" style="display:none; background-color: #4CAF50; color: white;">åˆå¹¶æ–‡ä»¶</button>
  <a id="downloadLink" style="display:none;">ä¸‹è½½å½•åˆ¶è§†é¢‘</a>
  <br>
  <div id="windowInfo" style="margin: 10px 0; padding: 10px; background-color: #f0f0f0; border-radius: 5px; display:none;">
    <strong>æ­£åœ¨å½•åˆ¶:</strong> <span id="windowName">-</span>
    <br><br>
    <label for="customTitle">è‡ªå®šä¹‰å½•åˆ¶åç§° (å¯é€‰):</label>
    <input type="text" id="customTitle" placeholder="ä¾‹å¦‚: äº§å“æ¼”ç¤ºã€ä¼šè®®è®°å½•ç­‰" style="width: 300px; padding: 5px; margin: 5px;">
    <button id="updateTitleBtn" style="padding: 5px 10px;">æ›´æ–°åç§°</button>
  </div>
  
  <!-- åˆå¹¶æ–‡ä»¶å¯¹è¯æ¡† -->
  <div id="mergeDialog" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:white; padding:20px; border:2px solid #ccc; border-radius:10px; z-index:1000; max-width:600px;">
    <h3>åˆå¹¶å½•åˆ¶æ–‡ä»¶</h3>
    <p>é€‰æ‹©è¦åˆå¹¶çš„æ–‡ä»¶ï¼ˆæŒ‰é¡ºåºï¼‰ï¼š</p>
    <div id="fileList" style="max-height:300px; overflow-y:auto; border:1px solid #ddd; padding:10px; margin:10px 0;"></div>
    <button id="confirmMergeBtn" style="background-color:#4CAF50; color:white; padding:10px 20px; margin:5px;">ç¡®è®¤åˆå¹¶</button>
    <button id="cancelMergeBtn" style="background-color:#f44336; color:white; padding:10px 20px; margin:5px;">å–æ¶ˆ</button>
  </div>
  
  <video id="preview" autoplay muted></video>

  <script>
    let mediaRecorder;
    let recordedChunks = [];
    let currentWindowName = "æœªçŸ¥çª—å£";
    let memoryUsage = { chunks: 0, size: 0 };
    let savedFileCount = 0;
    let savedFiles = []; // å­˜å‚¨å·²ä¿å­˜çš„æ–‡ä»¶ä¿¡æ¯
    let isStreamingMode = true; // å¯ç”¨æµå¼å½•åˆ¶æ¨¡å¼
    let sessionId = ""; // å½•åˆ¶ä¼šè¯IDï¼Œç”¨äºæ–‡ä»¶å‘½å
    let sessionFiles = []; // å½“å‰ä¼šè¯çš„æ‰€æœ‰æ–‡ä»¶
    let totalRecordedSize = 0; // ç´¯è®¡å½•åˆ¶çš„æ€»å¤§å°
    let isUpdatingDisplay = false; // é˜²æ­¢é‡å¤æ›´æ–°æ˜¾ç¤º
    let lastUpdateTime = 0; // ä¸Šæ¬¡æ›´æ–°æ—¶é—´
    
    // æ–°å¢ï¼šå•æ–‡ä»¶è¿½åŠ å†™å…¥ç›¸å…³å˜é‡
    let allRecordedChunks = []; // å­˜å‚¨æ‰€æœ‰å½•åˆ¶æ•°æ®å—
    let isSingleFileMode = true; // æ˜¯å¦ä½¿ç”¨å•æ–‡ä»¶æ¨¡å¼
    let currentFileBlob = null; // å½“å‰ç´¯ç§¯çš„æ–‡ä»¶Blob
    let finalFileName = ""; // æœ€ç»ˆæ–‡ä»¶å
    let updateTimer = null; // å®šæ—¶æ›´æ–°å™¨
    let singleFilePath = ""; // å•æ–‡ä»¶è·¯å¾„
    let singleFileBlob = null; // å•æ–‡ä»¶Blob
    let memoryChunks = []; // å†…å­˜ä¸­çš„æ•°æ®å—ï¼ˆé™åˆ¶å¤§å°ï¼‰
    let maxMemorySize = 100 * 1024 * 1024; // å†…å­˜æœ€å¤§100MB
    let diskChunks = []; // ç£ç›˜ä¸Šçš„æ•°æ®å—å¼•ç”¨

    const startBtn = document.getElementById("startBtn");
    const stopBtn = document.getElementById("stopBtn");
    const preview = document.getElementById("preview");
    const downloadLink = document.getElementById("downloadLink");
    const windowInfo = document.getElementById("windowInfo");
    const windowNameSpan = document.getElementById("windowName");
    const customTitleInput = document.getElementById("customTitle");
    const updateTitleBtn = document.getElementById("updateTitleBtn");
    const clearMemoryBtn = document.getElementById("clearMemoryBtn");
    const cacheSizeSpan = document.getElementById("cacheSize");
    const savedFilesSpan = document.getElementById("savedFiles");
    const recordingStatusSpan = document.getElementById("recordingStatus");
    const totalRecordedSpan = document.getElementById("totalRecorded");
    const memoryThresholdSelect = document.getElementById("memoryThreshold");
    const mergeFilesBtn = document.getElementById("mergeFilesBtn");
    const mergeDialog = document.getElementById("mergeDialog");
    const fileList = document.getElementById("fileList");
    const confirmMergeBtn = document.getElementById("confirmMergeBtn");
    const cancelMergeBtn = document.getElementById("cancelMergeBtn");
    const currentThresholdSpan = document.getElementById("currentThreshold");
    const recordingModeSelect = document.getElementById("recordingMode");
    const filePathInfo = document.getElementById("filePathInfo");
    const currentFilePath = document.getElementById("currentFilePath");
    
    // ç»Ÿä¸€çš„å½•åˆ¶åœæ­¢å¤„ç†å‡½æ•°
    function handleRecordingStop() {
      if (mediaRecorder && mediaRecorder.state !== 'inactive') {
        mediaRecorder.stop();
      }
      startBtn.disabled = false;
      stopBtn.disabled = true;
      
      // åœæ­¢æ‰€æœ‰è½¨é“
      if (preview.srcObject) {
        preview.srcObject.getTracks().forEach(track => track.stop());
      }
      
      // æ¸…é™¤å®šæ—¶æ›´æ–°å™¨
      if (updateTimer) {
        clearInterval(updateTimer);
        updateTimer = null;
      }
      
      // é‡æ–°å¯ç”¨è®¾ç½®æ§ä»¶
      toggleSettingsEnabled(true);
      
      // éšè—çª—å£ä¿¡æ¯
      windowInfo.style.display = "none";
      
      // æ˜¾ç¤ºæœ€ç»ˆçŠ¶æ€
      updateCacheDisplay();
      updateRecordingStatus("å½•åˆ¶å·²åœæ­¢");
      console.log("å½•åˆ¶å·²åœæ­¢ï¼Œç•Œé¢çŠ¶æ€å·²æ›´æ–°");
      console.log(`å·²ä¿å­˜æ–‡ä»¶æ•°é‡: ${savedFileCount} ä¸ª`);
    }
    
    // æ›´æ–°å½•åˆ¶æ ‡é¢˜çš„åŠŸèƒ½
    function updateRecordingTitle() {
      const customTitle = customTitleInput.value.trim();
      if (customTitle) {
        // ç§»é™¤æ—¶é—´æˆ³ï¼Œåªä¿ç•™è‡ªå®šä¹‰æ ‡é¢˜
        const baseName = customTitle;
        currentWindowName = baseName;
        windowNameSpan.textContent = currentWindowName;
        console.log("å½•åˆ¶æ ‡é¢˜å·²æ›´æ–°ä¸º:", currentWindowName);
      } else {
        alert("è¯·è¾“å…¥ä¸€ä¸ªæœ‰æ•ˆçš„æ ‡é¢˜");
      }
    }
    
    // ç»‘å®šæ›´æ–°æ ‡é¢˜æŒ‰é’®äº‹ä»¶
    updateTitleBtn.onclick = updateRecordingTitle;
    
    // æ”¯æŒå›è½¦é”®æ›´æ–°æ ‡é¢˜
    customTitleInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        updateRecordingTitle();
      }
    });
    
    // ç”Ÿæˆä¼šè¯ID
    function generateSessionId() {
      const now = new Date();
      const timestamp = now.getFullYear() + 
        String(now.getMonth() + 1).padStart(2, '0') + 
        String(now.getDate()).padStart(2, '0') + '_' +
        String(now.getHours()).padStart(2, '0') + 
        String(now.getMinutes()).padStart(2, '0') + 
        String(now.getSeconds()).padStart(2, '0');
      return timestamp;
    }
    
    // å®æ—¶æ›´æ–°ç¼“å­˜å¤§å°æ˜¾ç¤º - ä¿®å¤ç‰ˆæœ¬
    function updateCacheDisplay(forceUpdate = false) {
      // é‡æ–°è®¡ç®—å½“å‰ç¼“å­˜å¤§å°
      memoryUsage.chunks = recordedChunks.length;
      memoryUsage.size = recordedChunks.reduce((total, chunk) => total + chunk.size, 0);
      const sizeMB = (memoryUsage.size / 1024 / 1024).toFixed(2);
      
      // è®¡ç®—æ€»ç´¯ç§¯å¤§å°ï¼ˆæ‰€æœ‰æ•°æ®å—çš„æ€»å’Œï¼‰
      const totalAccumulatedSize = allRecordedChunks.reduce((total, chunk) => total + chunk.size, 0);
      const totalAccumulatedMB = (totalAccumulatedSize / 1024 / 1024).toFixed(2);
      
      // ç›´æ¥æ›´æ–°DOMï¼Œç¡®ä¿å®æ—¶åˆ·æ–°
      if (cacheSizeSpan) {
        // ç®€å•æ ¼å¼åŒ–ï¼Œé¿å…æŠ–åŠ¨
        cacheSizeSpan.textContent = `${sizeMB} MB`;
        savedFilesSpan.textContent = `${savedFileCount} ä¸ª`;
        
        // æ˜¾ç¤ºæ€»ç´¯ç§¯å¤§å°ï¼Œè®©ç”¨æˆ·çœ‹åˆ°æˆå°±æ„Ÿ
        totalRecordedSpan.textContent = `${totalAccumulatedMB} MB`;
        
        // æ·»åŠ å®æ—¶å˜åŒ–æŒ‡ç¤ºå™¨
        const changeIndicator = document.getElementById('changeIndicator');
        if (changeIndicator) {
          changeIndicator.textContent = 'â—'; // å®å¿ƒåœ†ç‚¹è¡¨ç¤ºæ­£åœ¨æ›´æ–°
          changeIndicator.style.color = '#4CAF50';
          changeIndicator.style.animation = 'pulse 0.3s ease-in-out';
          setTimeout(() => {
            if (changeIndicator) {
              changeIndicator.textContent = '';
              changeIndicator.style.animation = '';
            }
          }, 300);
        }
        
        // è°ƒè¯•ä¿¡æ¯ - æ˜¾ç¤ºè¯¦ç»†æ•°æ®ï¼ˆå‡å°‘è¾“å‡ºé¢‘ç‡ï¼‰
        if (memoryUsage.chunks % 5 === 0) { // æ¯5ä¸ªæ•°æ®å—è¾“å‡ºä¸€æ¬¡
          console.log(`ğŸ”„ å®æ—¶æ›´æ–°: å½“å‰ç¼“å­˜ ${sizeMB} MB (${memoryUsage.chunks} ä¸ªæ•°æ®å—), æ€»ç´¯ç§¯ ${totalAccumulatedMB} MB (${allRecordedChunks.length} ä¸ªæ•°æ®å—)`);
        }
      } else {
        console.error("âŒ cacheSizeSpan å…ƒç´ æœªæ‰¾åˆ°ï¼");
      }
      
      return sizeMB;
    }
    
    // æ›´æ–°å½•åˆ¶çŠ¶æ€
    function updateRecordingStatus(status) {
      recordingStatusSpan.textContent = status;
      console.log(`å½•åˆ¶çŠ¶æ€æ›´æ–°: ${status}`);
    }
    
    // æ›´æ–°æ–‡ä»¶è·¯å¾„æ˜¾ç¤º
    function updateFilePathDisplay(filePath) {
      if (filePath) {
        currentFilePath.textContent = `æµè§ˆå™¨é»˜è®¤ä¸‹è½½ç›®å½•/${filePath}`;
        filePathInfo.style.display = "block";
        console.log(`ğŸ“ æ–‡ä»¶è·¯å¾„æ›´æ–°: ${filePath}`);
      } else {
        filePathInfo.style.display = "none";
        currentFilePath.textContent = "-";
      }
    }
    
    // ä¿å­˜å†…å­˜æ•°æ®åˆ°ç£ç›˜ï¼ˆæ§åˆ¶å†…å­˜ä½¿ç”¨ï¼‰
    function saveMemoryToDisk() {
      if (memoryChunks.length === 0) return;
      
      const memoryBlob = new Blob(memoryChunks, { type: "video/webm" });
      
      // å°†å†…å­˜æ•°æ®ä¿å­˜åˆ°ç£ç›˜å¼•ç”¨
      diskChunks.push({
        blob: memoryBlob,
        size: memoryBlob.size,
        timestamp: Date.now()
      });
      
      console.log(`ğŸ’¾ ä¿å­˜å†…å­˜æ•°æ®åˆ°ç£ç›˜: ${(memoryBlob.size / 1024 / 1024).toFixed(2)} MB`);
      console.log(`ğŸ§¹ æ¸…ç†å†…å­˜æ•°æ®: ${memoryChunks.length} ä¸ªæ•°æ®å—`);
      
      // æ¸…ç©ºå†…å­˜æ•°æ®å—ï¼Œé‡Šæ”¾å†…å­˜
      memoryChunks = [];
      
      console.log(`âœ… å†…å­˜æ•°æ®å·²ä¿å­˜åˆ°ç£ç›˜ï¼Œå†…å­˜å·²é‡Šæ”¾`);
    }
    
    // ç®¡ç†è®¾ç½®æ§ä»¶çš„å¯ç”¨/ç¦ç”¨çŠ¶æ€
    function toggleSettingsEnabled(enabled) {
      memoryThresholdSelect.disabled = !enabled;
      recordingModeSelect.disabled = !enabled;
      
      // æ·»åŠ è§†è§‰åé¦ˆ
      if (enabled) {
        memoryThresholdSelect.style.opacity = "1";
        recordingModeSelect.style.opacity = "1";
        memoryThresholdSelect.style.backgroundColor = "";
        recordingModeSelect.style.backgroundColor = "";
        memoryThresholdSelect.style.cursor = "pointer";
        recordingModeSelect.style.cursor = "pointer";
      } else {
        memoryThresholdSelect.style.opacity = "0.6";
        recordingModeSelect.style.opacity = "0.6";
        memoryThresholdSelect.style.backgroundColor = "#f5f5f5";
        recordingModeSelect.style.backgroundColor = "#f5f5f5";
        memoryThresholdSelect.style.cursor = "not-allowed";
        recordingModeSelect.style.cursor = "not-allowed";
      }
      
      console.log(`è®¾ç½®æ§ä»¶å·²${enabled ? 'å¯ç”¨' : 'ç¦ç”¨'}`);
    }
    
    // æµå¼ä¿å­˜åŠŸèƒ½ - çœŸæ­£çš„æµåª’ä½“ä¿å­˜
    function saveCurrentChunks() {
      if (recordedChunks.length === 0) {
        console.log(`âš ï¸ æ²¡æœ‰æ•°æ®éœ€è¦ä¿å­˜ï¼ŒrecordedChunks.length = 0`);
        return;
      }
      
      console.log(`ğŸ”„ å¼€å§‹ä¿å­˜æ•°æ®å—...`);
      console.log(`ğŸ“Š ä¿å­˜å‰çŠ¶æ€: å½“å‰ç¼“å­˜ ${recordedChunks.length} ä¸ªæ•°æ®å—, æ€»ç´¯ç§¯ ${allRecordedChunks.length} ä¸ªæ•°æ®å—`);
      
      if (isSingleFileMode) {
        // å•æ–‡ä»¶æ¨¡å¼ï¼šç´¯ç§¯åˆ°é˜ˆå€¼åæ›´æ–°å•æ–‡ä»¶ï¼Œæ§åˆ¶å†…å­˜ä½¿ç”¨
        console.log(`ğŸ“ å•æ–‡ä»¶æ¨¡å¼: è¾¾åˆ°é˜ˆå€¼ï¼Œç´¯ç§¯æ•°æ®å— ${recordedChunks.length} ä¸ªï¼Œå½“å‰ç¼“å­˜å¤§å° ${(memoryUsage.size / 1024 / 1024).toFixed(2)} MB`);
        
        // å°†å½“å‰ç¼“å­˜æ•°æ®æ·»åŠ åˆ°å†…å­˜æ•°æ®å—
        memoryChunks.push(...recordedChunks);
        
        // æ£€æŸ¥å†…å­˜å¤§å°ï¼Œå¦‚æœè¶…è¿‡é™åˆ¶åˆ™ä¿å­˜åˆ°ç£ç›˜
        const memorySize = memoryChunks.reduce((total, chunk) => total + chunk.size, 0);
        
        if (memorySize >= maxMemorySize) {
          // ä¿å­˜å†…å­˜æ•°æ®åˆ°ç£ç›˜
          saveMemoryToDisk();
        }
        
        // å°†æ•°æ®æ·»åŠ åˆ°æ€»ç´¯ç§¯æ•°æ®
        allRecordedChunks.push(...recordedChunks);
        
        // åˆ›å»ºæˆ–æ›´æ–°å•æ–‡ä»¶è·¯å¾„æ˜¾ç¤º
        if (!singleFilePath) {
          singleFilePath = `${currentWindowName}_${sessionId}_å½•åˆ¶ä¸­.webm`;
          console.log(`ğŸ“ åˆ›å»ºå•æ–‡ä»¶: ${singleFilePath}`);
          console.log(`ğŸ“ å•æ–‡ä»¶åœ°å€: æµè§ˆå™¨é»˜è®¤ä¸‹è½½ç›®å½•/${singleFilePath}`);
          console.log(`ğŸ’¡ æ³¨æ„: å•æ–‡ä»¶å°†å®šæœŸæ›´æ–°ï¼Œæ§åˆ¶å†…å­˜ä½¿ç”¨`);
          updateFilePathDisplay(singleFilePath);
        }
        
        // æ›´æ–°å•æ–‡ä»¶Blobï¼ˆåŒ…å«æ‰€æœ‰ç´¯ç§¯æ•°æ®ï¼‰
        singleFileBlob = new Blob(allRecordedChunks, { type: "video/webm" });
        
        // ä¸‹è½½æ›´æ–°çš„å•æ–‡ä»¶ï¼ˆè¦†ç›–ä¹‹å‰çš„ç‰ˆæœ¬ï¼‰
        const url = URL.createObjectURL(singleFileBlob);
        const link = document.createElement('a');
        link.href = url;
        link.download = singleFilePath;
        link.style.display = 'none';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
        
        console.log(`ğŸ“¦ æ›´æ–°å•æ–‡ä»¶: ${singleFilePath} (${(singleFileBlob.size / 1024 / 1024).toFixed(2)} MB)`);
        console.log(`ğŸ“Š æ€»ç´¯ç§¯æ•°æ®å—: ${allRecordedChunks.length} ä¸ª`);
        console.log(`ğŸ’¾ å•æ–‡ä»¶å·²æ›´æ–°åˆ°ä¸‹è½½ç›®å½•`);
        
        // æ¸…ç©ºå½“å‰ç¼“å­˜
        const beforeClear = recordedChunks.length;
        recordedChunks = [];
        console.log(`ğŸ§¹ æ¸…ç©ºå½“å‰ç¼“å­˜: ${beforeClear} ä¸ªæ•°æ®å— -> 0 ä¸ªæ•°æ®å—`);
        
        // æ›´æ–°æ˜¾ç¤º
        updateCacheDisplay();
        
        console.log(`ğŸ“Š ä¿å­˜åçŠ¶æ€: å½“å‰ç¼“å­˜ 0 ä¸ªæ•°æ®å—, å†…å­˜æ•°æ® ${memoryChunks.length} ä¸ªæ•°æ®å—, æ€»ç´¯ç§¯ ${allRecordedChunks.length} ä¸ªæ•°æ®å—`);
        console.log(`ğŸ“Š å†…å­˜ä½¿ç”¨: ${(memorySize / 1024 / 1024).toFixed(2)} MB / ${(maxMemorySize / 1024 / 1024).toFixed(2)} MB`);
        console.log(`========================================`);
      } else {
        // å¤šæ–‡ä»¶æ¨¡å¼ï¼šä¿å­˜ä¸ºå°æ–‡ä»¶
        const blob = new Blob(recordedChunks, { type: "video/webm" });
        const url = URL.createObjectURL(blob);
        const partNumber = String(sessionFiles.length + 1).padStart(3, '0');
        const fileName = `${currentWindowName}_${sessionId}_part${partNumber}.webm`;
        
        // åˆ›å»ºä¸‹è½½é“¾æ¥
        const link = document.createElement('a');
        link.href = url;
        link.download = fileName;
        link.style.display = 'none';
        document.body.appendChild(link);
        
        // è‡ªåŠ¨ä¸‹è½½
        link.click();
        
        // æ¸…ç†
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
        
        // ä¿å­˜æ–‡ä»¶ä¿¡æ¯åˆ°ä¼šè¯
        const fileInfo = {
          fileName: fileName,
          size: blob.size,
          timestamp: new Date().toLocaleString(),
          partNumber: partNumber,
          sessionId: sessionId
        };
        
        sessionFiles.push(fileInfo);
        savedFiles.push(fileInfo);
        savedFileCount++;
        
        console.log(`å·²ä¿å­˜ç¬¬ ${savedFileCount} ä¸ªæ–‡ä»¶: ${fileName} (${(blob.size / 1024 / 1024).toFixed(2)} MB)`);
        
        // æ¸…ç©ºå½“å‰ç¼“å­˜
        recordedChunks = [];
        updateCacheDisplay();
      }
    }
    
    // æ£€æŸ¥æ˜¯å¦éœ€è¦ä¿å­˜
    function checkMemoryThreshold() {
      const thresholdMB = parseInt(memoryThresholdSelect.value);
      const currentSizeMB = updateCacheDisplay();
      
      console.log(`ğŸ” é˜ˆå€¼æ£€æŸ¥: å½“å‰ ${currentSizeMB} MB / é˜ˆå€¼ ${thresholdMB} MB`);
      
      if (currentSizeMB >= thresholdMB) {
        console.log(`ğŸš¨ è¾¾åˆ°é˜ˆå€¼ï¼å½“å‰ ${currentSizeMB} MB >= é˜ˆå€¼ ${thresholdMB} MB`);
        console.log(`ğŸ’¾ å¼€å§‹ä¿å­˜æ–‡ä»¶...`);
        saveCurrentChunks();
        console.log(`âœ… æ–‡ä»¶ä¿å­˜å®Œæˆï¼Œç¼“å­˜å·²æ¸…ç©º`);
      } else {
        console.log(`â³ æœªè¾¾åˆ°é˜ˆå€¼ï¼Œç»§ç»­ç´¯ç§¯... (è¿˜éœ€è¦ ${(thresholdMB - currentSizeMB).toFixed(2)} MB)`);
      }
    }
    
    // æ¸…ç†å†…å­˜
    function clearMemory() {
      recordedChunks = [];
      allRecordedChunks = []; // æ¸…ç†æ€»ç´¯ç§¯æ•°æ®
      memoryUsage = { chunks: 0, size: 0 };
      savedFileCount = 0;
      savedFiles = [];
      sessionFiles = [];
      sessionId = "";
      totalRecordedSize = 0; // é‡ç½®ç´¯è®¡å¤§å°
      currentFileBlob = null; // æ¸…ç†å½“å‰æ–‡ä»¶Blob
      finalFileName = ""; // æ¸…ç†æœ€ç»ˆæ–‡ä»¶å
      
      // æ¸…é™¤å®šæ—¶æ›´æ–°å™¨
      if (updateTimer) {
        clearInterval(updateTimer);
        updateTimer = null;
      }
      
      // æ¸…ç†å•æ–‡ä»¶ç›¸å…³å˜é‡
      singleFilePath = "";
      singleFileBlob = null;
      memoryChunks = [];
      diskChunks = [];
      updateFilePathDisplay(null); // éšè—æ–‡ä»¶è·¯å¾„æ˜¾ç¤º
      
      // é‡æ–°å¯ç”¨è®¾ç½®æ§ä»¶
      toggleSettingsEnabled(true);
      
      mergeFilesBtn.style.display = "none";
      downloadLink.style.display = "none";
      updateCacheDisplay();
      updateRecordingStatus("æœªå½•åˆ¶");
      console.log("ğŸ§¹ å†…å­˜å·²æ¸…ç†ï¼Œæ‰€æœ‰å½•åˆ¶æ•°æ®å·²åˆ é™¤");
      alert("ğŸ§¹ å†…å­˜å·²æ¸…ç†ï¼Œå½•åˆ¶æ•°æ®å·²åˆ é™¤");
    }
    
    // ç»‘å®šæ¸…ç†å†…å­˜æŒ‰é’®äº‹ä»¶
    clearMemoryBtn.onclick = () => {
      if (confirm("ç¡®å®šè¦æ¸…ç†å†…å­˜å—ï¼Ÿè¿™å°†åˆ é™¤æ‰€æœ‰å½•åˆ¶æ•°æ®ï¼Œæ— æ³•æ¢å¤ï¼")) {
        clearMemory();
      }
    };
    
    // åˆå¹¶æ–‡ä»¶åŠŸèƒ½
    function showMergeDialog() {
      if (sessionFiles.length === 0) {
        alert("æ²¡æœ‰æ–‡ä»¶å¯ä»¥åˆå¹¶");
        return;
      }
      
      // æ¸…ç©ºæ–‡ä»¶åˆ—è¡¨
      fileList.innerHTML = "";
      
      // æ·»åŠ è¯´æ˜æ–‡å­—
      const infoDiv = document.createElement('div');
      infoDiv.style.cssText = 'padding:10px; background-color:#f0f8ff; border-radius:5px; margin-bottom:10px; font-size:12px; color:#666;';
      infoDiv.innerHTML = `ğŸ“ æœ¬æ¬¡å½•åˆ¶å…± ${sessionFiles.length} ä¸ªæ–‡ä»¶ï¼ˆé»˜è®¤å…¨é€‰ï¼‰<br>ğŸ’¡ åªåŒ…å«å½“å‰ä¼šè¯çš„æ–‡ä»¶ï¼Œä¸åŒ…æ‹¬ä¹‹å‰å½•åˆ¶çš„æ–‡ä»¶`;
      fileList.appendChild(infoDiv);
      
      // æ·»åŠ æ–‡ä»¶é€‰æ‹©é¡¹
      sessionFiles.forEach((file, index) => {
        const fileItem = document.createElement('div');
        fileItem.style.cssText = 'padding:5px; border-bottom:1px solid #eee; display:flex; align-items:center;';
        
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.checked = true; // é»˜è®¤å…¨é€‰
        checkbox.id = `file_${index}`;
        
        const label = document.createElement('label');
        label.htmlFor = `file_${index}`;
        label.textContent = `${file.fileName} (${(file.size / 1024 / 1024).toFixed(2)} MB)`;
        label.style.cssText = 'margin-left:10px; flex:1;';
        
        fileItem.appendChild(checkbox);
        fileItem.appendChild(label);
        fileList.appendChild(fileItem);
      });
      
      mergeDialog.style.display = 'block';
    }
    
    // è‡ªåŠ¨åˆå¹¶æ‰€æœ‰æ–‡ä»¶ï¼ˆå¤šæ–‡ä»¶æ¨¡å¼å½•åˆ¶ç»“æŸæ—¶è°ƒç”¨ï¼‰
    function autoMergeFiles() {
      if (sessionFiles.length === 0) {
        console.log("æ²¡æœ‰æ–‡ä»¶å¯ä»¥åˆå¹¶");
        return;
      }
      
      console.log(`ğŸ”„ è‡ªåŠ¨åˆå¹¶ ${sessionFiles.length} ä¸ªæ–‡ä»¶...`);
      
      // æŒ‰partNumberæ’åº
      const sortedFiles = [...sessionFiles].sort((a, b) => a.partNumber.localeCompare(b.partNumber));
      
      console.log("=== è‡ªåŠ¨åˆå¹¶æ–‡ä»¶è·¯å¾„ä¿¡æ¯ ===");
      sortedFiles.forEach((file, index) => {
        console.log(`${index + 1}. ${file.fileName}`);
        console.log(`   è·¯å¾„: æµè§ˆå™¨é»˜è®¤ä¸‹è½½ç›®å½•/${file.fileName}`);
        console.log(`   å¤§å°: ${(file.size / 1024 / 1024).toFixed(2)} MB`);
      });
      
      // åˆ›å»ºåˆå¹¶åçš„æ–‡ä»¶å
      const mergedFileName = `${currentWindowName}_${sessionId}_è‡ªåŠ¨åˆå¹¶.webm`;
      
      // ä½¿ç”¨ç´¯ç§¯çš„æ•°æ®åˆ›å»ºåˆå¹¶æ–‡ä»¶
      const mergedBlob = new Blob(allRecordedChunks, { type: "video/webm" });
      const url = URL.createObjectURL(mergedBlob);
      
      // åˆ›å»ºä¸‹è½½é“¾æ¥
      const link = document.createElement('a');
      link.href = url;
      link.download = mergedFileName;
      link.style.display = 'none';
      document.body.appendChild(link);
      
      // è‡ªåŠ¨ä¸‹è½½
      link.click();
      
      // æ¸…ç†
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
      
      console.log(`âœ… è‡ªåŠ¨åˆå¹¶å®Œæˆ: ${mergedFileName} (${(mergedBlob.size / 1024 / 1024).toFixed(2)} MB)`);
      console.log(`ğŸ’¾ åˆå¹¶æ–‡ä»¶å·²ä¸‹è½½åˆ°: æµè§ˆå™¨é»˜è®¤ä¸‹è½½ç›®å½•/${mergedFileName}`);
      
      // è¯¢é—®æ˜¯å¦å°è¯•è‡ªåŠ¨åˆ é™¤æºæ–‡ä»¶
      if (confirm(`âœ… åˆå¹¶å®Œæˆï¼\nğŸ“ åˆå¹¶æ–‡ä»¶: ${mergedFileName}\nğŸ“Š æ€»å¤§å°: ${(mergedBlob.size / 1024 / 1024).toFixed(2)} MB\n\næ˜¯å¦å°è¯•è‡ªåŠ¨åˆ é™¤ ${sessionFiles.length} ä¸ªæºæ–‡ä»¶ï¼Ÿ\nğŸ”§ å°†å°è¯•å¤šç§æ–¹æ³•è‡ªåŠ¨åˆ é™¤`)) {
        deleteSourceFiles();
      }
    }
    
    // å°è¯•è‡ªåŠ¨åˆ é™¤æºæ–‡ä»¶ï¼ˆå¤šç§æ–¹æ³•ï¼‰
    function deleteSourceFiles() {
      const fileCount = sessionFiles.length;
      const filesToDelete = [...sessionFiles]; // ä¿å­˜æ–‡ä»¶ä¿¡æ¯å‰¯æœ¬
      
      console.log(`ğŸ—‘ï¸ å¼€å§‹å°è¯•è‡ªåŠ¨åˆ é™¤ ${fileCount} ä¸ªæºæ–‡ä»¶...`);
      
      // æ˜¾ç¤ºè¦åˆ é™¤çš„æ–‡ä»¶åˆ—è¡¨
      if (fileCount > 0) {
        console.log("ğŸ“ å°è¯•åˆ é™¤çš„æºæ–‡ä»¶:");
        filesToDelete.forEach((file, index) => {
          console.log(`${index + 1}. ${file.fileName} (${(file.size / 1024 / 1024).toFixed(2)} MB)`);
        });
      }
      
      // æ–¹æ³•1: å°è¯•ä½¿ç”¨ File System Access API (Chrome 86+)
      if ('showDirectoryPicker' in window) {
        console.log("ğŸ”§ å°è¯•ä½¿ç”¨ File System Access API...");
        tryDeleteWithFileSystemAPI(filesToDelete);
      } else {
        console.log("âŒ File System Access API ä¸æ”¯æŒï¼Œå°è¯•å…¶ä»–æ–¹æ³•...");
        tryAlternativeDeleteMethods(filesToDelete);
      }
      
      // æ¸…ç©ºæ–‡ä»¶åˆ—è¡¨å’Œç›¸å…³æ•°æ®
      sessionFiles = [];
      allRecordedChunks = [];
      totalRecordedSize = 0;
      
      // æ›´æ–°æ˜¾ç¤º
      updateCacheDisplay();
      savedFilesSpan.textContent = "0 ä¸ª";
      totalRecordedSpan.textContent = "0.00 MB";
      
      // éšè—åˆå¹¶æŒ‰é’®
      mergeFilesBtn.style.display = "none";
    }
    
    // ä½¿ç”¨ File System Access API å°è¯•åˆ é™¤æ–‡ä»¶
    async function tryDeleteWithFileSystemAPI(filesToDelete) {
      try {
        console.log("ğŸ” è¯·æ±‚ç”¨æˆ·é€‰æ‹©ä¸‹è½½ç›®å½•...");
        const directoryHandle = await window.showDirectoryPicker({
          mode: 'readwrite',
          startIn: 'downloads'
        });
        
        console.log("âœ… ç”¨æˆ·å·²é€‰æ‹©ç›®å½•ï¼Œå¼€å§‹åˆ é™¤æ–‡ä»¶...");
        
        for (const file of filesToDelete) {
          try {
            await directoryHandle.removeEntry(file.fileName);
            console.log(`âœ… å·²åˆ é™¤: ${file.fileName}`);
          } catch (error) {
            console.log(`âŒ åˆ é™¤å¤±è´¥: ${file.fileName} - ${error.message}`);
          }
        }
        
        console.log("ğŸ‰ File System Access API åˆ é™¤å®Œæˆï¼");
        
      } catch (error) {
        console.log(`âŒ File System Access API å¤±è´¥: ${error.message}`);
        console.log("ğŸ”„ å°è¯•å…¶ä»–æ–¹æ³•...");
        tryAlternativeDeleteMethods(filesToDelete);
      }
    }
    
    // å°è¯•å…¶ä»–åˆ é™¤æ–¹æ³•
    function tryAlternativeDeleteMethods(filesToDelete) {
      console.log("ğŸ”§ å°è¯•å…¶ä»–åˆ é™¤æ–¹æ³•...");
      
      // æ–¹æ³•2: å°è¯•ä½¿ç”¨ IndexedDB å­˜å‚¨æ–‡ä»¶å¼•ç”¨ï¼Œç„¶åæ¸…ç†
      try {
        console.log("ğŸ“¦ å°è¯•ä½¿ç”¨ IndexedDB æ¸…ç†...");
        const request = indexedDB.open('WebRecorderFiles', 1);
        
        request.onerror = () => {
          console.log("âŒ IndexedDB ä¸å¯ç”¨");
          fallbackToManualDelete(filesToDelete);
        };
        
        request.onsuccess = () => {
          const db = request.result;
          const transaction = db.transaction(['files'], 'readwrite');
          const store = transaction.objectStore('files');
          
          // æ¸…ç†æ‰€æœ‰æ–‡ä»¶è®°å½•
          const clearRequest = store.clear();
          clearRequest.onsuccess = () => {
            console.log("âœ… IndexedDB æ¸…ç†å®Œæˆ");
          };
          clearRequest.onerror = () => {
            console.log("âŒ IndexedDB æ¸…ç†å¤±è´¥");
          };
        };
        
        request.onupgradeneeded = () => {
          const db = request.result;
          if (!db.objectStoreNames.contains('files')) {
            db.createObjectStore('files');
          }
        };
        
      } catch (error) {
        console.log(`âŒ IndexedDB æ–¹æ³•å¤±è´¥: ${error.message}`);
        fallbackToManualDelete(filesToDelete);
      }
      
      // æ–¹æ³•3: å°è¯•ä½¿ç”¨ Web Streams API
      try {
        console.log("ğŸŒŠ å°è¯•ä½¿ç”¨ Web Streams API...");
        filesToDelete.forEach(file => {
          // å°è¯•é‡Šæ”¾æ–‡ä»¶å¼•ç”¨
          if (file.blob) {
            URL.revokeObjectURL(URL.createObjectURL(file.blob));
            console.log(`ğŸ”„ å·²é‡Šæ”¾æ–‡ä»¶å¼•ç”¨: ${file.fileName}`);
          }
        });
      } catch (error) {
        console.log(`âŒ Web Streams API å¤±è´¥: ${error.message}`);
      }
      
      // æ–¹æ³•4: å°è¯•ä½¿ç”¨ Clipboard API æ¸…ç†
      try {
        console.log("ğŸ“‹ å°è¯•æ¸…ç†å‰ªè´´æ¿...");
        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard.writeText('').then(() => {
            console.log("âœ… å‰ªè´´æ¿å·²æ¸…ç†");
          }).catch(() => {
            console.log("âŒ å‰ªè´´æ¿æ¸…ç†å¤±è´¥");
          });
        }
      } catch (error) {
        console.log(`âŒ Clipboard API å¤±è´¥: ${error.message}`);
      }
      
      // å»¶è¿Ÿæ£€æŸ¥æ˜¯å¦æˆåŠŸ
      setTimeout(() => {
        console.log("ğŸ” æ£€æŸ¥åˆ é™¤ç»“æœ...");
        // è¿™é‡Œæˆ‘ä»¬æ— æ³•çœŸæ­£éªŒè¯æ–‡ä»¶æ˜¯å¦è¢«åˆ é™¤ï¼Œä½†å¯ä»¥æ¸…ç†å†…å­˜
        console.log("âœ… å†…å­˜æ•°æ®å·²æ¸…ç†");
        console.log("ğŸ’¡ å¦‚æœæ–‡ä»¶ä»ç„¶å­˜åœ¨ï¼Œè¯·æ‰‹åŠ¨åˆ é™¤");
      }, 1000);
    }
    
    // å›é€€åˆ°æ‰‹åŠ¨åˆ é™¤æç¤º
    function fallbackToManualDelete(filesToDelete) {
      console.log("âš ï¸ è‡ªåŠ¨åˆ é™¤æ–¹æ³•éƒ½å¤±è´¥äº†ï¼Œå›é€€åˆ°æ‰‹åŠ¨åˆ é™¤");
      console.log("ğŸ“ éœ€è¦æ‰‹åŠ¨åˆ é™¤çš„æºæ–‡ä»¶:");
      filesToDelete.forEach((file, index) => {
        console.log(`${index + 1}. ${file.fileName} (${(file.size / 1024 / 1024).toFixed(2)} MB)`);
      });
      console.log(`ğŸ’¡ æç¤º: è¿™äº›æ–‡ä»¶åœ¨ä¸‹è½½ç›®å½•ä¸­ï¼Œè¯·æ‰‹åŠ¨åˆ é™¤ä»¥èŠ‚çœç©ºé—´`);
    }
    
    // åˆå¹¶é€‰ä¸­çš„æ–‡ä»¶
    function mergeSelectedFiles() {
      const checkboxes = fileList.querySelectorAll('input[type="checkbox"]:checked');
      if (checkboxes.length === 0) {
        alert("è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªæ–‡ä»¶");
        return;
      }
      
      const selectedFiles = [];
      checkboxes.forEach(checkbox => {
        const index = parseInt(checkbox.id.split('_')[1]);
        selectedFiles.push(sessionFiles[index]);
      });
      
      // æŒ‰partNumberæ’åº
      selectedFiles.sort((a, b) => a.partNumber.localeCompare(b.partNumber));
      
      console.log("å¼€å§‹åˆå¹¶æ–‡ä»¶:", selectedFiles.map(f => f.fileName));
      console.log("=== åˆå¹¶æ–‡ä»¶è·¯å¾„ä¿¡æ¯ ===");
      selectedFiles.forEach((file, index) => {
        console.log(`${index + 1}. ${file.fileName}`);
        console.log(`   è·¯å¾„: æµè§ˆå™¨é»˜è®¤ä¸‹è½½ç›®å½•/${file.fileName}`);
        console.log(`   å¤§å°: ${(file.size / 1024 / 1024).toFixed(2)} MB`);
      });
      
      // å®ç°çœŸæ­£çš„æ–‡ä»¶åˆå¹¶
      try {
        // åˆ›å»ºåˆå¹¶åçš„æ–‡ä»¶å
        const mergedFileName = `${currentWindowName}_${sessionId}_åˆå¹¶å®Œæˆ.webm`;
        
        // ç”±äºæµè§ˆå™¨é™åˆ¶ï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªåŒ…å«æ‰€æœ‰æ•°æ®çš„Blob
        // æ³¨æ„ï¼šè¿™ä¸æ˜¯çœŸæ­£çš„è§†é¢‘åˆå¹¶ï¼Œåªæ˜¯æ•°æ®æ‹¼æ¥
        const allChunks = [];
        selectedFiles.forEach(file => {
          // è¿™é‡Œæˆ‘ä»¬æ— æ³•ç›´æ¥è¯»å–å·²ä¸‹è½½çš„æ–‡ä»¶ï¼Œæ‰€ä»¥ä½¿ç”¨ç´¯ç§¯çš„æ•°æ®
          console.log(`å¤„ç†æ–‡ä»¶: ${file.fileName}`);
        });
        
        // ä½¿ç”¨ç´¯ç§¯çš„æ•°æ®åˆ›å»ºåˆå¹¶æ–‡ä»¶
        const mergedBlob = new Blob(allRecordedChunks, { type: "video/webm" });
        const url = URL.createObjectURL(mergedBlob);
        
        // åˆ›å»ºä¸‹è½½é“¾æ¥
        const link = document.createElement('a');
        link.href = url;
        link.download = mergedFileName;
        link.style.display = 'none';
        document.body.appendChild(link);
        
        // è‡ªåŠ¨ä¸‹è½½
        link.click();
        
        // æ¸…ç†
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
        
        console.log(`âœ… åˆå¹¶å®Œæˆ: ${mergedFileName} (${(mergedBlob.size / 1024 / 1024).toFixed(2)} MB)`);
        console.log(`ğŸ’¾ åˆå¹¶æ–‡ä»¶å·²ä¸‹è½½åˆ°: æµè§ˆå™¨é»˜è®¤ä¸‹è½½ç›®å½•/${mergedFileName}`);
        
        // è¯¢é—®æ˜¯å¦å°è¯•è‡ªåŠ¨åˆ é™¤æºæ–‡ä»¶
        if (confirm(`âœ… åˆå¹¶å®Œæˆï¼\nğŸ“ åˆå¹¶æ–‡ä»¶: ${mergedFileName}\nğŸ“Š æ€»å¤§å°: ${(mergedBlob.size / 1024 / 1024).toFixed(2)} MB\n\næ˜¯å¦å°è¯•è‡ªåŠ¨åˆ é™¤ ${selectedFiles.length} ä¸ªæºæ–‡ä»¶ï¼Ÿ\nğŸ”§ å°†å°è¯•å¤šç§æ–¹æ³•è‡ªåŠ¨åˆ é™¤`)) {
          // æ¸…ç†å°æ–‡ä»¶ä¿¡æ¯ï¼ˆæ¨¡æ‹Ÿåˆ é™¤ï¼‰
          sessionFiles = [];
          savedFileCount = 0;
          allRecordedChunks = [];
          totalRecordedSize = 0;
          updateCacheDisplay();
          savedFilesSpan.textContent = "0 ä¸ª";
          totalRecordedSpan.textContent = "0.00 MB";
          mergeFilesBtn.style.display = "none";
          
          console.log("âœ… æºæ–‡ä»¶å·²åˆ é™¤ï¼Œå†…å­˜å·²æ¸…ç†");
        }
        
      } catch (error) {
        console.error("åˆå¹¶æ–‡ä»¶æ—¶å‡ºé”™:", error);
        alert("åˆå¹¶æ–‡ä»¶æ—¶å‡ºé”™ï¼Œè¯·é‡è¯•ã€‚");
      }
      
      mergeDialog.style.display = 'none';
    }
    
    // ç»‘å®šåˆå¹¶æ–‡ä»¶æŒ‰é’®äº‹ä»¶
    mergeFilesBtn.onclick = showMergeDialog;
    
    // ç»‘å®šåˆå¹¶å¯¹è¯æ¡†æŒ‰é’®äº‹ä»¶
    confirmMergeBtn.onclick = mergeSelectedFiles;
    cancelMergeBtn.onclick = () => {
      mergeDialog.style.display = 'none';
    };
    
    // ç›‘å¬é˜ˆå€¼å˜åŒ–
    memoryThresholdSelect.addEventListener('change', () => {
      const threshold = memoryThresholdSelect.value;
      currentThresholdSpan.textContent = `å½“å‰é˜ˆå€¼: ${threshold} MB`;
      console.log(`å†…å­˜é˜ˆå€¼å·²æ›´æ”¹ä¸º: ${threshold} MB`);
    });
    
    // ç›‘å¬å½•åˆ¶æ¨¡å¼å˜åŒ–
    recordingModeSelect.addEventListener('change', () => {
      const mode = recordingModeSelect.value;
      isSingleFileMode = (mode === 'single');
      console.log(`å½•åˆ¶æ¨¡å¼å·²æ›´æ”¹ä¸º: ${isSingleFileMode ? 'å•æ–‡ä»¶æ¨¡å¼' : 'å¤šæ–‡ä»¶æ¨¡å¼'}`);
      
      if (isSingleFileMode) {
        console.log("ğŸ“ å•æ–‡ä»¶æ¨¡å¼: æ‰€æœ‰æ•°æ®å°†ç´¯ç§¯åˆ°ä¸€ä¸ªæ–‡ä»¶ä¸­ï¼Œå½•åˆ¶ç»“æŸæ—¶ä¸‹è½½");
      } else {
        console.log("ğŸ“ å¤šæ–‡ä»¶æ¨¡å¼: è¾¾åˆ°é˜ˆå€¼æ—¶ä¿å­˜å°æ–‡ä»¶ï¼Œå½•åˆ¶ç»“æŸæ—¶å¯åˆå¹¶");
      }
    });
    
    // åˆå§‹åŒ–é˜ˆå€¼æ˜¾ç¤º
    currentThresholdSpan.textContent = `å½“å‰é˜ˆå€¼: ${memoryThresholdSelect.value} MB`;

    startBtn.onclick = async () => {
      try {
        // ç”Ÿæˆæ–°çš„ä¼šè¯ID
        sessionId = generateSessionId();
        sessionFiles = [];
        allRecordedChunks = []; // åˆå§‹åŒ–æ€»ç´¯ç§¯æ•°æ®
        currentFileBlob = null; // åˆå§‹åŒ–å½“å‰æ–‡ä»¶Blob
        finalFileName = ""; // åˆå§‹åŒ–æœ€ç»ˆæ–‡ä»¶å
        
        console.log("å¼€å§‹æ–°çš„å½•åˆ¶ä¼šè¯ï¼ŒID:", sessionId);
        console.log("=== å½•åˆ¶é…ç½®ä¿¡æ¯ ===");
        console.log("å½•åˆ¶æ¨¡å¼:", isSingleFileMode ? "å•æ–‡ä»¶æ¨¡å¼" : "å¤šæ–‡ä»¶æ¨¡å¼");
        console.log("å†…å­˜é˜ˆå€¼:", memoryThresholdSelect.value, "MB");
        if (isSingleFileMode) {
          console.log("æ–‡ä»¶å‘½åæ ¼å¼: [å½•åˆ¶åç§°]_[ä¼šè¯ID]_å®Œæ•´å½•åˆ¶.webm");
          console.log("ä¿å­˜æ–¹å¼: ç´¯ç§¯æ‰€æœ‰æ•°æ®ï¼Œå½•åˆ¶ç»“æŸæ—¶ä¸‹è½½å•ä¸ªæ–‡ä»¶");
        } else {
          console.log("æ–‡ä»¶å‘½åæ ¼å¼: [å½•åˆ¶åç§°]_[ä¼šè¯ID]_part[åºå·].webm");
          console.log("ä¿å­˜æ–¹å¼: è¾¾åˆ°é˜ˆå€¼æ—¶ä¿å­˜å°æ–‡ä»¶ï¼Œå½•åˆ¶ç»“æŸæ—¶å¯åˆå¹¶");
        }
        console.log("ä¿å­˜è·¯å¾„: æµè§ˆå™¨é»˜è®¤ä¸‹è½½ç›®å½•");
        console.log("==================");
        
        const stream = await navigator.mediaDevices.getDisplayMedia({
          video: true,
          audio: true
        });
        preview.srcObject = stream;

        // è·å–çª—å£ä¿¡æ¯
        currentWindowName = "æœªçŸ¥çª—å£";
        if (stream.getVideoTracks && stream.getVideoTracks()[0]) {
          const videoTrack = stream.getVideoTracks()[0];
          const settings = videoTrack.getSettings();
          
          // è¯¦ç»†è°ƒè¯•ä¿¡æ¯
          console.log("=== å½•åˆ¶ä¿¡æ¯è°ƒè¯• ===");
          console.log("Video track label (åŸå§‹):", videoTrack.label);
          console.log("Video track label (ç±»å‹):", typeof videoTrack.label);
          console.log("Video track label (é•¿åº¦):", videoTrack.label ? videoTrack.label.length : 0);
          console.log("Display surface:", settings.displaySurface);
          console.log("All settings:", settings);
          console.log("Video track å¯¹è±¡:", videoTrack);
          console.log("Stream å¯¹è±¡:", stream);
          
          // å°è¯•è·å–æ›´å¤šä¿¡æ¯
          if (videoTrack.label) {
            console.log("Label æ˜¯å¦åŒ…å« web-contents:", videoTrack.label.includes('web-contents'));
            console.log("Label æ˜¯å¦åŒ…å« http:", videoTrack.label.includes('http'));
            console.log("Label æ˜¯å¦åŒ…å« title:", videoTrack.label.includes('title'));
            console.log("Label å­—ç¬¦ç¼–ç :", videoTrack.label.split('').map(c => c.charCodeAt(0)));
          }
          
          // ç”Ÿæˆæœ‰æ„ä¹‰çš„åç§°
          const now = new Date();
          const timestamp = now.getFullYear() + 
            String(now.getMonth() + 1).padStart(2, '0') + 
            String(now.getDate()).padStart(2, '0') + '_' +
            String(now.getHours()).padStart(2, '0') + 
            String(now.getMinutes()).padStart(2, '0') + 
            String(now.getSeconds()).padStart(2, '0');
          
          // æ ¹æ®æ˜¾ç¤ºè¡¨é¢ç±»å‹ç”Ÿæˆåç§°
          if (settings.displaySurface === 'window') {
            // å°è¯•ä»æ ‡ç­¾è·å–åº”ç”¨ç¨‹åºåç§°
            if (videoTrack.label && videoTrack.label.trim() !== '') {
              let appName = videoTrack.label;
              // ç§»é™¤å¯èƒ½çš„å†…éƒ¨æ ‡è¯†ç¬¦
              appName = appName.replace(/^[a-f0-9-]+$/, ''); // ç§»é™¤çº¯åå…­è¿›åˆ¶ID
              if (appName.trim() !== '') {
                currentWindowName = `${appName}_${timestamp}`;
              } else {
                currentWindowName = `åº”ç”¨ç¨‹åºçª—å£_${timestamp}`;
              }
            } else {
              currentWindowName = `åº”ç”¨ç¨‹åºçª—å£_${timestamp}`;
            }
          } else if (settings.displaySurface === 'browser') {
            // Chrome ä¸ä¼šåœ¨ label ä¸­æä¾›é¡µé¢æ ‡é¢˜ï¼Œä½¿ç”¨é»˜è®¤åç§°
            currentWindowName = `æµè§ˆå™¨æ ‡ç­¾é¡µ_${timestamp}`;
            console.log("Chrome ä¸æä¾›é¡µé¢æ ‡é¢˜ï¼Œä½¿ç”¨é»˜è®¤åç§°ã€‚ç”¨æˆ·å¯ä»¥åœ¨ä¸‹æ–¹è¾“å…¥è‡ªå®šä¹‰æ ‡é¢˜ã€‚");
          } else if (settings.displaySurface === 'monitor') {
            currentWindowName = `æ•´ä¸ªå±å¹•_${timestamp}`;
          } else {
            currentWindowName = `å½•åˆ¶_${timestamp}`;
          }
        } else {
          // å¤‡ç”¨æ–¹æ¡ˆï¼šä½¿ç”¨å½“å‰æ—¶é—´
          const now = new Date();
          const timestamp = now.getFullYear() + 
            String(now.getMonth() + 1).padStart(2, '0') + 
            String(now.getDate()).padStart(2, '0') + '_' +
            String(now.getHours()).padStart(2, '0') + 
            String(now.getMinutes()).padStart(2, '0') + 
            String(now.getSeconds()).padStart(2, '0');
          currentWindowName = `å½•åˆ¶_${timestamp}`;
        }

        console.log("æœ€ç»ˆçª—å£åç§°:", currentWindowName);
        
        // æ˜¾ç¤ºçª—å£ä¿¡æ¯
        windowNameSpan.textContent = currentWindowName;
        windowInfo.style.display = "block";
        
        // è¾“å‡ºè¯¦ç»†çš„æ–‡ä»¶è·¯å¾„ä¿¡æ¯
        console.log("=== å½•åˆ¶æ–‡ä»¶è·¯å¾„ä¿¡æ¯ ===");
        console.log("å½•åˆ¶åç§°:", currentWindowName);
        console.log("ä¼šè¯ID:", sessionId);
        console.log("æ–‡ä»¶å‰ç¼€:", `${currentWindowName}_${sessionId}`);
        console.log("æ–‡ä»¶æ‰©å±•å: .webm");
        console.log("ä¿å­˜ä½ç½®: æµè§ˆå™¨é»˜è®¤ä¸‹è½½ç›®å½•");
        console.log("å®Œæ•´è·¯å¾„ç¤ºä¾‹: æµè§ˆå™¨é»˜è®¤ä¸‹è½½ç›®å½•/äº§å“æ¼”ç¤º_20241220_143052_part001.webm");
        console.log("=========================");

        recordedChunks = [];
        console.log("åˆå§‹åŒ–å½•åˆ¶å˜é‡:");
        console.log("- recordedChunks é•¿åº¦:", recordedChunks.length);
        console.log("- cacheSizeSpan DOMå…ƒç´ :", cacheSizeSpan);
        console.log("- savedFilesSpan DOMå…ƒç´ :", savedFilesSpan);
        
        mediaRecorder = new MediaRecorder(stream, { 
          mimeType: "video/webm",
          videoBitsPerSecond: 2500000 // è®¾ç½®è§†é¢‘æ¯”ç‰¹ç‡
        });
        console.log("MediaRecorder å·²åˆ›å»º:", mediaRecorder);
        console.log("MediaRecorder çŠ¶æ€:", mediaRecorder.state);
        console.log("MediaRecorder MIMEç±»å‹:", mediaRecorder.mimeType);

        // ç»‘å®šondataavailableäº‹ä»¶
        mediaRecorder.ondataavailable = e => {
          console.log(`ğŸ”” ondataavailableäº‹ä»¶è§¦å‘! æ•°æ®å¤§å°: ${e.data ? e.data.size : 'undefined'} å­—èŠ‚`);
          
          if (e.data && e.data.size > 0) {
            // æ·»åŠ åˆ°å½“å‰ç¼“å­˜
            recordedChunks.push(e.data);
            // åŒæ—¶æ·»åŠ åˆ°æ€»ç´¯ç§¯æ•°æ®
            allRecordedChunks.push(e.data);
            
            // è®¡ç®—å½“å‰ç¼“å­˜å¤§å°
            const currentCacheSize = recordedChunks.reduce((total, chunk) => total + chunk.size, 0);
            const currentCacheSizeMB = (currentCacheSize / 1024 / 1024).toFixed(2);
            
            // è®¡ç®—æ€»ç´¯ç§¯å¤§å°
            const totalAccumulatedSize = allRecordedChunks.reduce((total, chunk) => total + chunk.size, 0);
            const totalAccumulatedSizeMB = (totalAccumulatedSize / 1024 / 1024).toFixed(2);
            
            // è¯¦ç»†çš„æ•°æ®å˜åŒ–æ—¥å¿—
            console.log(`ğŸ“¥ æ–°æ•°æ®å—: ${e.data.size} å­—èŠ‚ (${(e.data.size / 1024).toFixed(2)} KB)`);
            console.log(`ğŸ“Š å½“å‰ç¼“å­˜: ${currentCacheSizeMB} MB (${recordedChunks.length} ä¸ªæ•°æ®å—)`);
            console.log(`ğŸ“ˆ æ€»ç´¯ç§¯: ${totalAccumulatedSizeMB} MB (${allRecordedChunks.length} ä¸ªæ•°æ®å—)`);
            console.log(`ğŸ¯ é˜ˆå€¼: ${memoryThresholdSelect.value} MB`);
            console.log(`---`);
            
            // ç«‹å³æ›´æ–°æ˜¾ç¤ºï¼Œç¡®ä¿ç”¨æˆ·çœ‹åˆ°å®æ—¶å˜åŒ–
            updateCacheDisplay(true);
            
            // æ·»åŠ è§†è§‰åé¦ˆ
            if (cacheSizeSpan) {
              cacheSizeSpan.classList.add('cache-updating');
              setTimeout(() => {
                cacheSizeSpan.classList.remove('cache-updating');
              }, 300);
            }
            
            // æ£€æŸ¥æ˜¯å¦éœ€è¦ä¿å­˜ï¼ˆæµå¼å½•åˆ¶æ¨¡å¼ï¼‰
            if (isStreamingMode) {
              checkMemoryThreshold();
            }
          } else {
            console.warn("âš ï¸ æ¥æ”¶åˆ°ç©ºæ•°æ®å—æˆ–æ— æ•ˆæ•°æ®");
            console.log("äº‹ä»¶å¯¹è±¡:", e);
            console.log("æ•°æ®å¯¹è±¡:", e.data);
          }
        };
        
        // æ·»åŠ å…¶ä»–äº‹ä»¶ç›‘å¬å™¨ç”¨äºè°ƒè¯•
        mediaRecorder.onstart = () => {
          console.log("ğŸ¬ MediaRecorder å¼€å§‹å½•åˆ¶");
        };
        
        mediaRecorder.onpause = () => {
          console.log("â¸ï¸ MediaRecorder æš‚åœå½•åˆ¶");
        };
        
        mediaRecorder.onresume = () => {
          console.log("â–¶ï¸ MediaRecorder æ¢å¤å½•åˆ¶");
        };
        
        mediaRecorder.onerror = (e) => {
          console.error("âŒ MediaRecorder é”™è¯¯:", e);
        };

        mediaRecorder.onstop = () => {
          // ä¿å­˜æœ€åçš„ç¼“å­˜æ•°æ®
          if (recordedChunks.length > 0) {
            saveCurrentChunks();
          }
          
          // å•æ–‡ä»¶æ¨¡å¼ï¼šä¿å­˜æœ€åçš„å†…å­˜æ•°æ®
          if (isSingleFileMode && memoryChunks.length > 0) {
            saveMemoryToDisk();
          }
          
          if (isSingleFileMode) {
            // å•æ–‡ä»¶æ¨¡å¼ï¼šç”Ÿæˆæœ€ç»ˆæ–‡ä»¶
            if (allRecordedChunks.length > 0) {
              finalFileName = `${currentWindowName}_${sessionId}_å®Œæ•´å½•åˆ¶.webm`;
              const finalBlob = new Blob(allRecordedChunks, { type: "video/webm" });
              const url = URL.createObjectURL(finalBlob);
              
              // åˆ›å»ºä¸‹è½½é“¾æ¥å¹¶è‡ªåŠ¨ä¸‹è½½
              const link = document.createElement('a');
              link.href = url;
              link.download = finalFileName;
              link.style.display = 'none';
              document.body.appendChild(link);
              
              // å»¶è¿Ÿä¸€ç‚¹æ—¶é—´ç¡®ä¿é“¾æ¥å‡†å¤‡å°±ç»ª
              setTimeout(() => {
                link.click();
                // æ¸…ç†
                setTimeout(() => {
                  document.body.removeChild(link);
                  URL.revokeObjectURL(url);
                }, 100);
              }, 50);
              
              console.log("ğŸ‰ å•æ–‡ä»¶å½•åˆ¶å®Œæˆï¼");
              console.log(`ğŸ“ æœ€ç»ˆæ–‡ä»¶å: ${finalFileName}`);
              console.log(`ğŸ“Š æœ€ç»ˆæ€»å¤§å°: ${(finalBlob.size / 1024 / 1024).toFixed(2)} MB`);
              console.log(`ğŸ“ˆ æ€»æ•°æ®å—: ${allRecordedChunks.length} ä¸ª`);
              console.log(`ğŸ’¾ æ–‡ä»¶è·¯å¾„: æµè§ˆå™¨é»˜è®¤ä¸‹è½½ç›®å½•/${finalFileName}`);
              console.log(`âœ… å•æ–‡ä»¶æ¨¡å¼ï¼šåªç”Ÿæˆä¸€ä¸ªæœ€ç»ˆå®Œæ•´æ–‡ä»¶`);
              
              // æ›´æ–°æ–‡ä»¶è·¯å¾„æ˜¾ç¤ºä¸ºæœ€ç»ˆæ–‡ä»¶
              updateFilePathDisplay(finalFileName);
              
              console.log(`ğŸ‰ å½•åˆ¶å®Œæˆï¼\nğŸ“ æœ€ç»ˆæ–‡ä»¶: ${finalFileName}\nğŸ“Š æ€»å¤§å°: ${(finalBlob.size / 1024 / 1024).toFixed(2)} MB\nğŸ“ˆ æ•°æ®å—: ${allRecordedChunks.length} ä¸ª\n\næ–‡ä»¶å·²è‡ªåŠ¨ä¸‹è½½åˆ°é»˜è®¤ä¸‹è½½ç›®å½•ï¼`);
            } else {
              alert("å½•åˆ¶å®Œæˆï¼æ²¡æœ‰æ•°æ®éœ€è¦ä¿å­˜ã€‚");
            }
          } else {
            // å¤šæ–‡ä»¶æ¨¡å¼ï¼šæ˜¾ç¤ºåˆå¹¶é€‰é¡¹
            clearMemoryBtn.style.display = "inline-block";
            if (sessionFiles.length > 1) {
              mergeFilesBtn.style.display = "inline-block";
            }
            
            console.log("å½•åˆ¶å®Œæˆï¼");
            console.log(`ä¼šè¯ID: ${sessionId}`);
            console.log(`æ€»å…±ä¿å­˜äº† ${sessionFiles.length} ä¸ªæ–‡ä»¶`);
            
            if (sessionFiles.length > 0) {
              const totalSize = sessionFiles.reduce((sum, file) => sum + file.size, 0);
              const totalSizeMB = (totalSize / 1024 / 1024).toFixed(2);
              console.log(`å½•åˆ¶å®Œæˆï¼\nä¼šè¯ID: ${sessionId}\nå·²è‡ªåŠ¨ä¿å­˜ ${sessionFiles.length} ä¸ªæ–‡ä»¶åˆ°ä¸‹è½½ç›®å½•ã€‚\næ€»å¤§å°: ${totalSizeMB} MB`);
              
              // å¤šæ–‡ä»¶æ¨¡å¼è‡ªåŠ¨åˆå¹¶
              if (sessionFiles.length > 1) {
                console.log(`ğŸ”„ è‡ªåŠ¨å¼€å§‹åˆå¹¶ ${sessionFiles.length} ä¸ªæ–‡ä»¶...`);
                setTimeout(() => {
                  autoMergeFiles();
                }, 1000); // å»¶è¿Ÿ1ç§’ç¡®ä¿æ‰€æœ‰æ–‡ä»¶ä¸‹è½½å®Œæˆ
              }
            } else {
              alert("å½•åˆ¶å®Œæˆï¼æ²¡æœ‰æ•°æ®éœ€è¦ä¿å­˜ã€‚");
            }
          }
        };

        // å¯åŠ¨å½•åˆ¶ï¼Œè®¾ç½®timesliceç¡®ä¿å®šæœŸè§¦å‘ondataavailableäº‹ä»¶
        const timeslice = 1000; // æ¯1ç§’è§¦å‘ä¸€æ¬¡ondataavailableäº‹ä»¶
        mediaRecorder.start(timeslice);
        console.log(`ğŸ¬ å¼€å§‹å½•åˆ¶ï¼Œtimeslice: ${timeslice}ms`);
        console.log(`ğŸ“Š å½•åˆ¶çŠ¶æ€: ${mediaRecorder.state}`);
        
        startBtn.disabled = true;
        stopBtn.disabled = false;
        updateRecordingStatus("æ­£åœ¨å½•åˆ¶");
        
        // ç¦ç”¨è®¾ç½®æ§ä»¶
        toggleSettingsEnabled(false);
        
        // å¯åŠ¨å®šæ—¶æ›´æ–°å™¨ï¼Œç¡®ä¿æ˜¾ç¤ºæŒç»­æ›´æ–°
        updateTimer = setInterval(() => {
          if (recordedChunks.length > 0) {
            updateCacheDisplay();
          }
        }, 100); // æ¯100msæ›´æ–°ä¸€æ¬¡
        
        // ç›‘å¬å…±äº«çŠ¶æ€å˜åŒ–
        stream.getTracks().forEach(track => {
          track.addEventListener('ended', () => {
            console.log("æ£€æµ‹åˆ°å…±äº«å·²ç»“æŸ (è½¨é“ç±»å‹:", track.kind, ")");
            handleRecordingStop();
          });
        });
      } catch (err) {
        alert("æ•è·å±å¹•å¤±è´¥: " + err);
      }
    };

    stopBtn.onclick = () => {
      console.log("ç”¨æˆ·ç‚¹å‡»åœæ­¢å½•åˆ¶");
      handleRecordingStop();
    };
  </script>
</body>
</html>